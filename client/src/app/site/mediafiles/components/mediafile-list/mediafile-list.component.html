<os-head-bar [mainButton]="canUploadFiles" [multiSelectMode]="false" (mainEvent)="onMainEvent()">
    <!-- Title -->
    <div class="title-slot">
        <h2 translate>Files</h2>
    </div>

    <!-- Menu -->
    <div class="menu-slot" *osPerms="'mediafiles.can_manage'">
        <button type="button" mat-icon-button (click)="createNewFolder(newFolderDialog)">
            <mat-icon>create_new_folder</mat-icon>
        </button>
        <!--<button type="button" mat-icon-button [matMenuTriggerFor]="mediafilesMenu">
            <mat-icon>more_vert</mat-icon>
        </button>-->
    </div>

    <!-- Multiselect info -->
    <!--<div *ngIf="this.isMultiSelect" class="central-info-slot">
        <button mat-icon-button (click)="toggleMultiSelect()"><mat-icon>arrow_back</mat-icon></button>
        <span>{{ selectedRows.length }}&nbsp;</span><span translate>selected</span>
    </div>-->
</os-head-bar>

<!-- TODO: Sort bar -->

<div>
    <button mat-button (click)="changeDirectory(null)">
        <span translate>Base folder</span>
    </button>
    <span *ngFor="let directory of directoryChain; let last=last">
        <mat-icon>chevron_right</mat-icon>
        <button *ngIf="!last" mat-button (click)="changeDirectory(directory.id)">
            {{ directory.title }}
        </button>
        <button *ngIf="last" mat-button (click)="onEditFile(directory)">
            {{ directory.title }}
            <mat-icon>edit</mat-icon>
        </button>
    </span>

    <button mat-icon-button *ngIf="directory" (click)="changeDirectory(directory.parent_id)">
        <mat-icon>arrow_upward</mat-icon>
    </button>
</div>

<div *ngIf="directory && directory.inherited_access_groups_id !== true">
    <span translate>Visibility of this directory:</span>
    <span *ngIf="directory.inherited_access_groups_id === false" translate>No one</span>
    <span *ngIf="directory.has_inherited_access_groups" translate>
        <os-icon-container icon="group">{{ directory.inherited_access_groups }}</os-icon-container>
    </span>
</div>

<mat-table [dataSource]="dataSource" class="os-listview-table">
    <!-- Projector button -->
    <ng-container matColumnDef="projector">
        <td mat-cell *matCellDef="let mediafile">
            <os-projector-button *ngIf="mediafile.isProjectable()" class="projector-button" [object]="mediafile"></os-projector-button>
        </td>
    </ng-container>

    <ng-container matColumnDef="icon">
        <td mat-cell *matCellDef="let mediafile">
            <mat-icon>{{ mediafile.getIcon() }}</mat-icon>
        </td>
    </ng-container>

    <ng-container matColumnDef="title">
        <td mat-cell *matCellDef="let mediafile">
            <a target="_blank" [routerLink]="mediafile.url" *ngIf="mediafile.is_file">
                {{ mediafile.title }}
            </a>
            <a (click)="changeDirectory(mediafile.id)" *ngIf="mediafile.is_directory">
                {{ mediafile.title }}
            </a>
        </td>
    </ng-container>

    <ng-container matColumnDef="info">
        <td mat-cell *matCellDef="let mediafile">
            <os-icon-container *ngIf="mediafile.is_file" icon="data_usage">{{ mediafile.size }}</os-icon-container>
            <os-icon-container *ngIf="mediafile.access_groups.length" icon="group">{{ mediafile.access_groups }}</os-icon-container>
        </td>
    </ng-container>

    <ng-container matColumnDef="indicator">
        <td mat-cell *matCellDef="let mediafile">
            <div
                *ngIf="getFileSettings(mediafile).length > 0"
                [matMenuTriggerFor]="singleMediafileMenu"
                [matMenuTriggerData]="{ file: file }"
                [matTooltip]="formatIndicatorTooltip(mediafile)"
            >
                <mat-icon *ngIf="mediafile.isFont()">text_fields</mat-icon>
                <mat-icon *ngIf="mediafile.isImage()">insert_photo</mat-icon>
            </div>
        </td>
    </ng-container>

    <ng-container matColumnDef="menu">
        <td mat-cell *matCellDef="let mediafile">
            <button
                mat-icon-button
                [matMenuTriggerFor]="singleMediafileMenu"
                [matMenuTriggerData]="{ mediafile: mediafile }"
            >
                <!-- TODO: [disabled]="isMultiSelect" -->
                <mat-icon>more_vert</mat-icon>
            </button>
        </td>
    </ng-container>

    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
</mat-table>

<!-- Template for the managing buttons -->
<ng-template #manageButton let-mediafile="mediafile" let-action="action">
    <button mat-menu-item (click)="onManageButton($event, mediafile, action)">
        <mat-icon color="accent"> {{ isUsedAs(mediafile, action) ? 'check_box' : 'check_box_outline_blank' }} </mat-icon>
        <span>{{ getNameOfAction(action) }}</span>
    </button>
</ng-template>

<!-- Menu for single files in the list -->
<mat-menu #singleMediafileMenu="matMenu">
    <ng-template matMenuContent let-mediafile="mediafile">
        <!-- Exclusive for images -->
        <div *ngIf="mediafile.isImage()">
            <div *ngFor="let action of logoActions">
                <ng-container *ngTemplateOutlet="manageButton; context: { mediafile: mediafile, action: action }"></ng-container>
            </div>
        </div>

        <!-- Exclusive for fonts -->
        <div *ngIf="mediafile.isFont()">
            <div *ngFor="let action of fontActions">
                <ng-container *ngTemplateOutlet="manageButton; context: { mediafile: mediafile, action: action }"></ng-container>
            </div>
        </div>

        <!-- Edit and delete for all images -->
        <mat-divider *ngIf="mediafile.isFont() || mediafile.isImage()"></mat-divider>

        <os-speaker-button [object]="mediafile" [menuItem]="true"></os-speaker-button>
        <button mat-menu-item (click)="onEditFile(mediafile)">
            <mat-icon>edit</mat-icon>
            <span translate>Edit</span>
        </button>
        <button mat-menu-item (click)="move(moveDialog, mediafile)">
            <mat-icon>near_me</mat-icon>
            <span translate>Move</span>
        </button>
        <button mat-menu-item class="red-warning-text" (click)="onDelete(mediafile)">
            <mat-icon>delete</mat-icon>
            <span translate>Delete</span>
        </button>
    </ng-template>
</mat-menu>

<!-- Menu for Mediafiles -->
<!--<mat-menu #mediafilesMenu="matMenu">
    <div *ngIf="!isMultiSelect">
        <button mat-menu-item *osPerms="'mediafiles.can_manage'" (click)="toggleMultiSelect()">
            <mat-icon>library_add</mat-icon>
            <span translate>Multiselect</span>
        </button>
    </div>
    <div *ngIf="isMultiSelect">
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="selectAll()">
            <mat-icon>done_all</mat-icon>
            <span translate>Select all</span>
        </button>
        <button mat-menu-item [disabled]="!selectedRows.length" (click)="deselectAll()">
            <mat-icon>clear</mat-icon>
            <span translate>Deselect all</span>
        </button>
        <mat-divider></mat-divider>
        <button
            mat-menu-item
            *osPerms="'mediafiles.can_manage'"
            [disabled]="!selectedRows.length"
            (click)="deleteSelected()"
        >
            <mat-icon>delete</mat-icon>
            <span translate>Delete</span>
        </button>
    </div>
</mat-menu>-->

<ng-template #fileEditDialog>
    <h1 mat-dialog-title>{{ 'Edit details for' | translate }}</h1>
    <div class="os-form-card-mobile" mat-dialog-content>
        <form class="edit-file-form" [formGroup]="fileEditForm" (keydown)="keyDownFunction($event)">
            <mat-form-field>
                <input
                    type="text"
                    matInput
                    osAutofocus
                    required
                    formControlName="title"
                    placeholder="{{ 'New file name' | translate }}"
                />
                <mat-error *ngIf="fileEditForm.invalid" translate>Required</mat-error>
            </mat-form-field>

            <os-search-value-selector
                ngDefaultControl
                [formControl]="fileEditForm.get('access_groups_id')"
                [multiple]="true"
                listname="{{ 'Access groups' | translate }}"
                [InputListValues]="groupsBehaviorSubject"
            ></os-search-value-selector>
        </form>
    </div>
    <div mat-dialog-actions>
        <button
            type="submit"
            mat-button
            [disabled]="!fileEditForm.valid"
            color="primary"
            (click)="onSaveEditedFile(fileEditForm.value)"
        >
            <span translate>Save</span>
        </button>
        <button type="button" mat-button [mat-dialog-close]="null">
            <span translate>Cancel</span>
        </button>
    </div>
</ng-template>

<!-- New folder dialog -->
<ng-template #newFolderDialog>
    <h1 mat-dialog-title>
        <span translate>Create new directory</span>
    </h1>
    <div mat-dialog-content>
        <p translate>Please enter a name for the new directory:</p>
        <mat-form-field [formGroup]="newDirectoryForm">
            <input matInput osAutofocus formControlName="title" required/>
        </mat-form-field>
        <os-search-value-selector
            ngDefaultControl
            [formControl]="newDirectoryForm.get('access_groups_id')"
            [multiple]="true"
            listname="{{ 'Access groups' | translate }}"
            [InputListValues]="groupsBehaviorSubject"
        ></os-search-value-selector>
    </div>
    <div mat-dialog-actions>
        <button type="submit" mat-button color="primary" [mat-dialog-close]="true">
            <span translate>Save</span>
        </button>
        <button type="button" mat-button [mat-dialog-close]="null">
            <span translate>Cancel</span>
        </button>
    </div>
</ng-template>

<!-- Move dialog -->
<ng-template #moveDialog>
    <h1 mat-dialog-title>
        <span translate>Move to directory</span>
    </h1>
    <div mat-dialog-content>
        <p translate>Please select the directory to move to:</p>
        <os-search-value-selector
            ngDefaultControl
            [formControl]="moveForm.get('directory_id')"
            [multiple]="false"
            [includeNone]="true"
            [noneTitle]="'Base folder'"
            listname="{{ 'Parent directory' | translate }}"
            [InputListValues]="directoryBehaviorSubject"
        ></os-search-value-selector>
    </div>
    <div mat-dialog-actions>
        <button type="submit" mat-button color="primary" [mat-dialog-close]="true">
            <span translate>Move</span>
        </button>
        <button type="button" mat-button [mat-dialog-close]="null">
            <span translate>Cancel</span>
        </button>
    </div>
</ng-template>
